---
source: Rmd
title: Próximos pasos
teaching: 45
exercises: 45
---

```{r, include=FALSE}
```

::::::::::::::::::::::::::::::::::::::: objectives

- Presentar el proyecto Bioconductor.
- Introducir la noción de contenedores de datos.
- Brinde una descripción general del "Experimento resumido", ampliamente utilizado en
  análisis ómicos.

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::: questions

- ¿Qué es un "experimento resumido"?
- ¿Qué es un bioconductor?

::::::::::::::::::::::::::::::::::::::::::::::::::

## Próximos pasos

```{r, echo=FALSE, message=FALSE}
library("tidyverse")
```

Los datos en bioinformática suelen ser complejos.  Para solucionar esto, los desarrolladores de
definen contenedores de datos especializados (denominados clases) que
coinciden con las propiedades de los datos que necesitan manejar.

Este aspecto es fundamental para el proyecto **Bioconductor**[^Bioconductor]
, que utiliza la misma **infraestructura de datos central** en todos los paquetes. Esto
ciertamente contribuyó al éxito de Bioconductor. Se recomienda a los desarrolladores del paquete de bioconductores
que utilicen la infraestructura existente para
proporcionar coherencia, interoperabilidad y estabilidad al proyecto en su conjunto
.

[^Bioconductor]: El [Bioconductor](https://www.bioconductor.org) fue
    iniciado por Robert Gentleman, uno de los dos creadores del lenguaje R
    . Bioconductor proporciona herramientas dedicadas al análisis de datos ómicos
    . Bioconductor utiliza el lenguaje de programación estadística R
    y es de código abierto y desarrollo abierto.

Para ilustrar dicho contenedor de datos ómicos, presentaremos la clase
`SummarizedExperiment`.

## Experimento resumido

La siguiente figura representa la anatomía de la clase SummarizedExperiment.

```{r SE, echo=FALSE, out.width="80%"}
knitr::include_graphics("https://uclouvain-cbio.github.io/WSBIM1322/figs/SE.svg")
```

Los objetos de la clase SummarizedExperiment contienen:

- **Uno (o más) ensayos** que contienen los datos ómicos cuantitativos
  (datos de expresión), almacenados como un objeto similar a una matriz. Características (genes,
  transcripciones, proteínas, ...) se definen a lo largo de las filas y las muestras
  a lo largo de las columnas.

- Una ranura de **metadatos de muestra** que contiene covariables de muestra, almacenada como un marco de datos
  . Las filas de esta tabla representan muestras (las filas coinciden exactamente con las
  columnas de los datos de la expresión).

- Una ranura de **metadatos de características** que contiene covariables de características, almacenada como
  un marco de datos. Las filas de este marco de datos coinciden exactamente con las filas de los datos de expresión
  .

La naturaleza coordinada del `Experimento resumido` garantiza que
durante la manipulación de datos, las dimensiones de las diferentes ranuras
siempre coincidirán (es decir, las columnas en los datos de expresión y luego las filas en
los metadatos de muestra, así como las filas en los datos de expresión y
metadatos de características) durante la manipulación de datos. Por ejemplo, si tuviéramos que
excluir una muestra del ensayo, se eliminaría automáticamente
de los metadatos de la muestra en la misma operación.

Las ranuras de metadatos pueden generar covariables adicionales
(columnas) sin afectar las otras estructuras.

### Crear un experimento resumido

Para crear un `Experimento resumido`, crearemos los
componentes individuales, es decir, la matriz de recuento, la muestra y el gen
metadatos a partir de archivos csv. Por lo general, así es como se proporcionan
los datos de RNA-Seq (después de que se hayan procesado los datos sin procesar).

```{r, echo=FALSE, message=FALSE}
rna <- read_csv("data/rnaseq.csv")

## count matrix
counts <- rna %>%
  select(gene, sample, expression) %>%
  pivot_wider(names_from = sample,
              values_from = expression)

## convert to matrix and set row names
count_matrix <- counts %>% select(-gene) %>% as.matrix()
rownames(count_matrix) <- counts$gene

## sample annotation
sample_metadata <- rna %>%
  select(sample, organism, age, sex, infection, strain, time, tissue, mouse)

## remove redundancy
sample_metadata <- unique(sample_metadata)

## gene annotation
gene_metadata <- rna %>%
  select(gene, ENTREZID, product, ensembl_gene_id, external_synonym,
         chromosome_name, gene_biotype, phenotype_description,
         hsapiens_homolog_associated_gene_name)

# remove redundancy
gene_metadata <- unique(gene_metadata)

## write to csv
write.csv(count_matrix, file = "data/count_matrix.csv")
write.csv(gene_metadata, file = "data/gene_metadata.csv", row.names = FALSE)
write.csv(sample_metadata, file = "data/sample_metadata.csv", row.names = FALSE)
```

- **Una matriz de expresión**: cargamos la matriz de recuento, especificando que
  las primeras columnas contienen nombres de filas/genes, y convertimos el
  `data.frame` en una `matriz`. Puede descargarlo
  [aquí](https://carpentries-incubator.github.io/bioc-intro/data/count_matrix.csv).

```{r}
count_matrix <- read.csv("data/count_matrix.csv",
                         row.names = 1) %>%
    as.matrix()

count_matrix[1:5, ]
dim(count_matrix)
```

- **Una tabla que describe las muestras**, disponible
  [aquí](https://carpentries-incubator.github.io/bioc-intro/data/sample_metadata.csv).

```{r}
sample_metadata <- read.csv("data/sample_metadata.csv")
sample_metadata
dim(sample_metadata)
```

- **Una tabla que describe los genes**, disponible
  [aquí](https://carpentries-incubator.github.io/bioc-intro/data/gene_metadata.csv).

```{r}
gene_metadata <- read.csv("data/gene_metadata.csv")
gene_metadata[1:10, 1:4]
dim(gene_metadata)
```

Crearemos un `Experimento resumido` a partir de estas tablas:

- La matriz de recuento que se utilizará como **`ensayo`**

- La tabla que describe las muestras se utilizará como espacio de metadatos \*\*muestra
  \*\*

- La tabla que describe los genes se utilizará como espacio de **características
  metadatos**

Para hacer esto podemos juntar las diferentes partes usando el constructor
`SummarizedExperiment`:

```{r, message=FALSE, warning=FALSE}
## BiocManager::install("SummarizedExperiment")
library("SummarizedExperiment")
```

Primero, nos aseguramos de que las muestras estén en el mismo orden en la matriz de conteo
y la anotación de muestra, y lo mismo para los genes en
la matriz de conteo y la anotación de genes.

```{r}
stopifnot(rownames(count_matrix) == gene_metadata$gene)
stopifnot(colnames(count_matrix) == sample_metadata$sample)
```

```{r}
se <- SummarizedExperiment(assays = list(counts = count_matrix),
                           colData = sample_metadata,
                           rowData = gene_metadata)
se
```

### Guardar datos

Exportar datos a una hoja de cálculo, como hicimos en un episodio anterior, tiene
varias limitaciones, como las descritas en el primer capítulo
(posibles inconsistencias con `,` y `.` para los separadores decimales y
falta de definiciones de tipos de variables). Además, exportar datos a una hoja de cálculo
solo es relevante para datos rectangulares como marcos de datos
y matrices.

Una forma más general de guardar datos, que es específica de R y
garantiza que funciona en cualquier sistema operativo, es utilizar la función `saveRDS`
. Guardar objetos como este generará una representación binaria
en el disco (usando la extensión de archivo `rds` aquí), que
se puede volver a cargar en R usando la función `readRDS`.

```{r, eval=FALSE}
saveRDS(se, file = "data_output/se.rds")
rm(se)
se <- readRDS("data_output/se.rds")
head(se)
```

Para concluir, cuando se trata de guardar datos de R que se cargarán
nuevamente en R, guardar y cargar con `saveRDS` y `readRDS` es el enfoque preferido
. Si es necesario compartir datos tabulares con alguien
que no esté usando R, entonces exportarlos a una hoja de cálculo basada en texto es una
buena alternativa.

Usando esta estructura de datos, podemos acceder a la matriz de expresión con
la función `ensayo`:

```{r}
head(assay(se))
dim(assay(se))
```

Podemos acceder a los metadatos de muestra usando la función `colData`:

```{r}
colData(se)
dim(colData(se))
```

También podemos acceder a los metadatos de la característica usando la función `rowData`:

```{r}
head(rowData(se))
dim(rowData(se))
```

### Subconjunto de un experimento resumido

SummarizedExperiment se puede subconjunto como con marcos de datos, con
numéricos o con caracteres lógicos.

A continuación, creamos una nueva instancia de la clase SummarizedExperiment que
contiene solo las 5 primeras características para las 3 primeras muestras.

```{r}
se1 <- se[1:5, 1:3]
se1
```

```{r}
colData(se1)
rowData(se1)
```

También podemos usar la función `colData()` para crear un subconjunto de algo de
los metadatos de muestra o `rowData()` para crear un subconjunto de algo de los metadatos de característica
.  Por ejemplo, aquí conservamos solo los miARN y las muestras no
infectadas:

```{r}
se1 <- se[rowData(se)$gene_biotype == "miRNA",
          colData(se)$infection == "NonInfected"]
se1
assay(se1)
colData(se1)
rowData(se1)
```

<!--For the following exercise, you should download the SE.rda object
(that contains the `se` object), and open the file using the 'load()'
function.-->

<!-- ```{r, eval = FALSE, echo = FALSE} -->

<!-- download.file(url = "https://raw.githubusercontent.com/UCLouvain-CBIO/bioinfo-training-01-intro-r/master/data/SE.rda", -->

<!--               destfile = "data/SE.rda") -->

<!-- load("data/SE.rda") -->

<!-- ``` -->

:::::::::::::::::::::::::::::::::::::::  challenge

## Desafío

Extraiga los niveles de expresión génica de los 3 primeros genes en muestras
en el tiempo 0 y en el tiempo 8.

:::::::::::::::  solution

## Solución

```{r, purl=FALSE}
assay(se)[1:3, colData(se)$time != 4]

# Equivalent to
assay(se)[1:3, colData(se)$time == 0 | colData(se)$time == 8]
```

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::  challenge

## Desafío

Verifique que obtenga los mismos valores usando la tabla larga `rna`.

:::::::::::::::  solution

## Solución

```{r, purl=FALSE}
rna |>
    filter(gene %in% c("Asl", "Apod", "Cyd2d22")) |>
    filter(time != 4) |> select(expression)
```

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::::::::::::::::

La tabla larga y el `Experimento resumido` contienen la misma información
, pero simplemente están estructurados de manera diferente. Cada enfoque tiene sus
propias ventajas: el primero es una buena opción para los paquetes `tidyverse`,
mientras que el segundo es la estructura preferida para muchos pasos de procesamiento bioinformático y
estadístico. Por ejemplo, un RNA-Seq típico analiza usando
el paquete `DESeq2`.

#### Agregar variables a los metadatos

También podemos agregar información a los metadatos.
Supongamos que desea agregar el centro donde se recolectaron las muestras...

```{r}
colData(se)$center <- rep("University of Illinois", nrow(colData(se)))
colData(se)
```

¡Esto ilustra que los espacios de metadatos pueden crecer indefinidamente sin que
afecte a las otras estructuras!

### ordenadoResumidoExperimento

Quizás se pregunte: ¿podemos usar los comandos de tidyverse para interactuar con
objetos `SummarizedExperiment`? La respuesta es sí, podemos hacerlo con el paquete
`tidySummarizedExperiment`.

Recuerde cómo se ve nuestro objeto SummarizedExperiment:

```{r, message=FALSE}
se
```

Cargue `tidySummarizedExperiment` y luego eche un vistazo al objeto se
nuevamente.

```{r, message=FALSE}
#BiocManager::install("tidySummarizedExperiment")
library("tidySummarizedExperiment")

se
```

Sigue siendo un objeto `SummarizedExperiment`, por lo que mantiene la estructura eficiente
, pero ahora podemos verlo como un tibble. Tenga en cuenta que la primera línea de
el resultado dice esto, es una abstracción `SummarizedExperiment`\-`tibble`
. También podemos ver en la segunda línea del resultado el
número de transcripciones y muestras.

Si queremos volver a la vista estándar `Experimento resumido`,
podemos hacerlo.

```{r}
options("restore_SummarizedExperiment_show" = TRUE)
se
```

Pero aquí usamos la vista tibble.

```{r}
options("restore_SummarizedExperiment_show" = FALSE)
se
```

Ahora podemos usar los comandos de tidyverse para interactuar con el objeto
`SummarizedExperiment`.

Podemos usar `filter` para filtrar filas usando una condición, por ejemplo, para ver
todas las filas de una muestra.

```{r}
se %>% filter(.sample == "GSM2545336")
```

Podemos usar `select` para especificar las columnas que queremos ver.

```{r}
se %>% select(.sample)
```

Podemos usar `mutate` para agregar información de metadatos.

```{r}
se %>% mutate(center = "Heidelberg University")
```

También podemos combinar comandos con la canalización tidyverse `%>%`. Por ejemplo,
, podríamos combinar `group_by` y `summarise` para obtener los recuentos totales de
para cada muestra.

```{r}
se %>%
    group_by(.sample) %>%
    summarise(total_counts=sum(counts))
```

Podemos tratar el objeto ordenado SummarizedExperiment como un tibble normal
para trazar.

Aquí trazamos la distribución de recuentos por muestra.

```{r tidySE-plot}
se %>%
    ggplot(aes(counts + 1, group=.sample, color=infection)) +
    geom_density() +
    scale_x_log10() +
    theme_bw()
```

Para obtener más información sobre tidySummarizedExperiment, consulte el sitio web del paquete[aquí](https://stemangiola.github.io/tidySummarizedExperiment/).

**Llevar el mensaje a casa**

- `SummarizedExperiment` representa una forma eficiente de almacenar y
  manejar datos ómicos.

- Se utilizan en muchos paquetes de Bioconductores.

Si sigues la próxima formación centrada en el análisis de secuenciación de ARN,
aprenderás a utilizar el paquete Bioconductor `DESeq2` para realizar algunos
análisis de expresión diferencial.  Todo el análisis del paquete `DESeq2`
se maneja en un `SummarizedExperiment`.

:::::::::::::::::::::::::::::::::::::::: keypoints

- Bioconductor es un proyecto que proporciona soporte y paquetes para la
  comprensión de datos biológicos de alto rendimiento.
- Un `Experimento resumido` es un tipo de objeto útil para almacenar y
  administrar datos ómicos de alto rendimiento.

::::::::::::::::::::::::::::::::::::::::::::::::::
